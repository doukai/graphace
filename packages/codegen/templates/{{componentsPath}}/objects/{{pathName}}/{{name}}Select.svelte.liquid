<script lang="ts">
	import { createEventDispatcher } from 'svelte';
	import type { Errors } from '@graphace/commons';
	import type { Option } from '@graphace/ui';
	import { ObjectSelect } from '@graphace/ui-graphql';
	import { graphql, {{ name }}Input, Operator } from '$houdini';

	export let value: {{ name }}Input | ({{ name }}Input | null | undefined)[] | null | undefined = undefined;
	export let selected: Option | Option[] | undefined = undefined;
	export let errors: Errors | undefined = undefined;
	export let list: boolean | undefined = false;
	export let id: string | null = null;
	export let name: string;
	export let disabled = false;
	export let readonly = false;
	export let placeholder: string | null | undefined = undefined;
	export let className: string = '';

	const dispatch = createEventDispatcher<{
		change: {
			value: {{ name }}Input | ({{ name }}Input | null | undefined)[] | null | undefined;
		};
	}>();

	const {{ name }}NameListQuery = graphql(`
		query {{ name }}NameListQuery($name: StringExpression, $first: Int) {
			{{ name | camelCase }}List(name: $name, first: $first) {
				{{ idName }}
				name
				description
			}
		}
	`);
	
	if (Array.isArray(value)) {
		selected = value?.map((item) => ({
			label: item?.name,
			value: item?.{{ idName }}
		}));
		value = value.map((item) => ({ where: { {{ idName }}: { val: item?.{{ idName }} } } }));
	} else if (value) {
		selected = { label: value.name, value: value.{{ idName }} };
		value = { where: { {{ idName }}: { val: value.{{ idName }} } } };
	}

	let searchText: string = '';
	let loading: boolean = false;
	let options: Option[] = [];

	$: options =
		${{ name }}NameListQuery.data?.{{ name | camelCase }}List?.map((item) => ({
			label: item?.name,
			value: item?.{{ idName }}
		})) || [];
</script>

<ObjectSelect
	{list}
	{id}
	{name}
	{disabled}
	{readonly}
	{placeholder}
	{errors}
	{className}
	bind:options
	bind:value={selected}
	{loading}
	on:change={(e) => {
		if (Array.isArray(e.detail.value)) {
			value = e.detail.value.map((item) => ({ where: { {{ idName }}: { val: item.value } } }));
		} else if (e.detail.value && !Array.isArray(e.detail.value)) {
			value = { where: { {{ idName }}: { val: e.detail.value.value } } };
		} else {
			value = undefined;
		}
		dispatch('change', { value });
	{% raw %}}{% endraw %}}
	on:search={(e) => {
		if (e.detail.searchValue) {
			loading = true;
			{{ name }}NameListQuery.fetch({
				variables: { name: { opr: Operator.LK, val: `%${e.detail.searchValue}%` } }
			}).finally(() => (loading = false));
		} else {
			loading = true;
			{{ name }}NameListQuery.fetch({ variables: { name: undefined, first: 10 } }).finally(
				() => (loading = false)
			);
		}
	{% raw %}}{% endraw %}}
/>
